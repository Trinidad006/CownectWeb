rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Usuarios: cada usuario autenticado lee/escribe su propio documento.
    // NOTA: La API de PayPal (capture-subscription-order) actualiza plan/suscripción desde el servidor
    // sin auth. Si esta regla bloquea esas escrituras, usa Firebase Admin SDK en la API
    // o comenta la regla y usa temporalmente: allow read, write: if request.auth != null || true;
    match /usuarios/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // PayPal órdenes pendientes: la API del servidor escribe/lee (sin auth).
    // Si usas Firebase Client SDK en API routes, necesitas reglas que permitan escritura.
    // Alternativa: usa Firebase Admin SDK en las rutas API (bypasea reglas).
    match /paypal_pending_orders/{orderId} {
      allow read, write: if true; // Temporal: permite API. En producción usa Admin SDK.
    }
    match /paypal_pending_subscriptions/{orderId} {
      allow read, write: if true; // Temporal: permite API. En producción usa Admin SDK.
    }

    // Animales: el dueño puede todo; otros solo leer en venta
    match /animales/{animalId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null &&
        resource.data.usuario_id == request.auth.uid;
    }

    // Pesos, vacunaciones: solo el dueño del animal
    match /pesos/{docId} {
      allow read, write: if request.auth != null;
    }
    match /vacunaciones/{docId} {
      allow read, write: if request.auth != null;
    }

    // Compras y calificaciones
    match /compras/{docId} {
      allow read, write: if request.auth != null;
    }
    match /calificaciones/{docId} {
      allow read, write: if request.auth != null;
    }
    match /reportes/{docId} {
      allow read, write: if request.auth != null;
    }
  }
}
